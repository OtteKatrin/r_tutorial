```{r, echo = FALSE}
source("output_hook.R")
```

# Data wrangling

## Overview of the main commands in this section

```{r, eval = FALSE}
## merge two data frames by different columns:
merge(
  x = winners,
  y = continents,
  by.x = "Nationality",
  by.y = "Entity"
)

## Add a new column:
winners_continents$Seconds_total <- winners_continents$Hours * 60^2 +
                                    winners_continents$Minutes * 60 +
                                    winners_continents$Seconds

## Show missing values:
is.na(winners_continents$Hours)

## Remove rows that have a missing in the specified column:
winners_continents_na <- winners_continents[!is.na(winners_continents$Hours), ]

## Add a new column conditionally to contents of other columns: 
winners_continents$Wheelchair <- ifelse(
  winners_continents$Category %in% c("Wheelchair Men", "Wheelchair Women"),
  yes = TRUE,
  no = FALSE
)

```

::: tidy
```{r, message = FALSE, eval = FALSE}
library(dplyr)

## Add a new column using mutate():
winners_continents <- winners_continents %>%
  mutate(Minutes_total = winners_continents$Hours * 60 +
                         winners_continents$Minutes *
                         winners_continents$Seconds / 60)
```
:::

## Data set

Suppose we want to look at the winners by continent (see [last chapter](subsetting.qmd) for the data set). In this case, we will have to add a list assigning each Nationality a continent. We can easily find such a list online, for example at [ourworldindata.org](https://ourworldindata.org/grapher/continents-according-to-our-world-in-data). I have already [downloaded](https://github.com/nickhaf/r_tutorial/tree/main/raw_data) the `.csv`, and we have already loaded it into R in the exercise 2 of [load data](http://localhost:3262/load_data.html#solution):

```{r, message = FALSE}
winners <- readRDS(file = "./raw_data/winners.rds")
continents <- read.csv(
  file = "./raw_data/continents.csv",
  sep = ";"
)
```

## Wide and long format


## Merging

To merge two data frames that include information that belongs together, we need a common column, on which we can combine them. In our case, this is the column containing the country, but they are named differently. This doesn't pose a problem, as we can define which columns should be taken from which data frame for merging:

```{r}
winners_continents <- merge(
  x = winners,
  y = continents,
  by.x = "Nationality",
  by.y = "Entity"
)
head(winners_continents)
```

Great! Now the information that belongs together is stored together.

## New columns

Adding new columns to a data frame is pretty straight forward. We just define the column name, and then assign it some input. For example, we could be interested in calculating the seconds each person needed to finish, and add that as a new column:

```{r}
winners_continents$Seconds_total <- winners_continents$Hours * 60^2 +
                                    winners_continents$Minutes * 60 +
                                    winners_continents$Seconds
head(winners_continents)
```

Or, using the `tidyverse` with the help of `mutate()`:

::: tidy
```{r, message = FALSE}
library(dplyr)

winners_continents <- winners_continents %>%
  mutate(Minutes_total = winners_continents$Hours * 60 + winners_continents$Minutes * winners_continents$Seconds / 60)
head(winners_continents)
```
:::

Hold on! Both new columns seem to have missing values, which is an important concept which we haven't talked about yet. So let's do that quickly, and then merge!

## Missing values

Missing values are denoted in R by `NA` (or `NaN` in some cases). They pretty strongly nullify a calculation - if one missing value is found somewhere along the line, the result will also be `NA` (if not specified otherwise):

```{r}
4 + 5 + NA
```

That's why our newly build columns include `NAs`: The column `Hours` already had some, and by adding with `NAs` we just produced new ones.

To check if values are `NA`, we can use `is.na()`:

```{r, output.lines = 4}
is.na(winners_continents$Hours)
```

Some `TRUEs`, so there are missing values here. Let's count them (Summing an [logical vector](basics.qmd#comparisons-and-logical-operators) counts the number of `TRUE` values.):

```{r}
sum(is.na(winners_continents$Hours))
```

We seem to have `5` missings in this column. There are multiple different ways to deal with missings. For this tutorial, we just remove cases with missing values on the `Hours` variable:

```{r, output.lines = 4}
winners_continents_na <- winners_continents[!is.na(winners_continents$Hours), ]
```

What happens here? Like always when filtering specific rows, we define a logical vector, which has a `TRUE` for all rows that have a missing on `ID` and a `FALSE` for all others (by using the `!` operator, which inverts the boolean values - otherwise we would extract all rows with missing values in the `Hours` column):

```{r, output.lines = 4}
!is.na(winners_continents$Hours)
```

We also assign a new name to the resulting data frame.

## ifelse

We can also add new values conditionally, for example by using the `ifelse()` function. For example, let's build a composite variable which summarizes whether the category was `Whelchair` or not:

```{r, output.lines = 4}
winners_continents$Wheelchair <- ifelse(
  winners_continents$Category %in% c("Wheelchair Men", "Wheelchair Women"),
  yes = TRUE,
  no = FALSE
)
winners_continents
```

::: tidy
```{r, output.lines = 4}
winners_continents <- winners_continents %>%
  mutate(over_3_h = ifelse(
    winners_continents$Hours < 2,
    yes = "below",
    no  = "over"
  ))

winners_continents
```
:::

## Exercises
